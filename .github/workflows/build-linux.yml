name: Build Linux

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip python3-venv ffmpeg
      
      - name: Bundle Python and FFmpeg
        run: |
          # Use the bundling script approach (same as local builds)
          # This ensures consistency and proper venv setup
          
          # Create resources directory structure
          mkdir -p resources/python
          mkdir -p resources/ffmpeg
          
          echo ""
          echo "=== Step 1: Python ==="
          echo "Setting up Python environment..."
          
          # Check if Python 3 is available
          if command -v python3 &> /dev/null; then
            PYTHON_VERSION=$(python3 --version | cut -d' ' -f2)
            echo "Found Python: $PYTHON_VERSION"
            
            # Create a virtual environment
            # Use --copies to avoid symlinks (better for app bundles)
            python3 -m venv --copies resources/python
            
            # Install yt-dlp in the venv
            echo "Installing yt-dlp..."
            resources/python/bin/pip install --upgrade pip
            resources/python/bin/pip install yt-dlp
            
            # CRITICAL: Fix pyvenv.cfg to use relative paths instead of hardcoded build machine paths
            # This makes the venv portable across different machines
            echo "Making venv portable..."
            PYTHON_VERSION_SHORT=$(resources/python/bin/python3 --version 2>&1 | awk '{print $2}' | cut -d. -f1,2)
            
            # Update pyvenv.cfg to use relative paths
            printf 'home = bin\ninclude-system-site-packages = false\nversion = %s\nexecutable = bin/python3\n' "$PYTHON_VERSION_SHORT" > resources/python/pyvenv.cfg
            
            # Fix all shebang lines in Python scripts to use relative paths
            find resources/python/bin -type f -name "*.py" -exec sed -i "1s|^#!.*python.*|#!/usr/bin/env python3|" {} \;
            find resources/python/bin -type f ! -name "*.py" -exec grep -l "^#!.*python" {} \; | while read script; do
                sed -i "1s|^#!.*|#!/usr/bin/env python3|" "$script"
            done
            
            # Ensure Python executable has correct permissions
            chmod +x resources/python/bin/python3
            
            # Make sure all scripts are executable
            find resources/python/bin -type f -exec chmod +x {} \;
            
            echo "✓ Python environment created and made portable"
          else
            echo "✗ Python 3 not found"
            exit 1
          fi
          
          # Copy downloader.py
          if [ -f "python/downloader.py" ]; then
            cp python/downloader.py resources/python/downloader.py
            echo "✓ Copied downloader.py"
          else
            echo "✗ downloader.py not found"
            exit 1
          fi
          
          echo ""
          echo "=== Step 2: FFmpeg ==="
          echo "Setting up FFmpeg..."
          
          # Bundle FFmpeg - try static build first, fallback to system FFmpeg
          mkdir -p resources/ffmpeg
          
          FFMPEG_DOWNLOADED=false
          
          # For Linux, try to download static build for better compatibility
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            # Download ARM64 static build
            FFMPEG_URL="https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-arm64-static.tar.xz"
            echo "Attempting to download ARM64 static FFmpeg..."
            if curl -L -f -o ffmpeg.tar.xz "$FFMPEG_URL" 2>/dev/null; then
              tar -xf ffmpeg.tar.xz
              cp ffmpeg-*-static/ffmpeg resources/ffmpeg/ffmpeg
              rm -rf ffmpeg-*-static ffmpeg.tar.xz
              FFMPEG_DOWNLOADED=true
              echo "✓ Downloaded ARM64 static FFmpeg"
            fi
          else
            # Download x64 static build
            FFMPEG_URL="https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz"
            echo "Attempting to download x64 static FFmpeg..."
            if curl -L -f -o ffmpeg.tar.xz "$FFMPEG_URL" 2>/dev/null; then
              tar -xf ffmpeg.tar.xz
              cp ffmpeg-*-static/ffmpeg resources/ffmpeg/ffmpeg
              rm -rf ffmpeg-*-static ffmpeg.tar.xz
              FFMPEG_DOWNLOADED=true
              echo "✓ Downloaded x64 static FFmpeg"
            fi
          fi
          
          # Fallback to system FFmpeg if download failed
          if [ "$FFMPEG_DOWNLOADED" = false ]; then
            echo "Static FFmpeg download failed, using system FFmpeg..."
            if command -v ffmpeg &> /dev/null; then
              FFMPEG_VERSION=$(ffmpeg -version | head -n1)
              echo "Found system FFmpeg: $FFMPEG_VERSION"
              cp $(which ffmpeg) resources/ffmpeg/ffmpeg
              echo "✓ Copied system FFmpeg"
            else
              echo "✗ FFmpeg not found"
              exit 1
            fi
          fi
          
          # Make ffmpeg executable
          chmod +x resources/ffmpeg/ffmpeg
          
          echo ""
          echo "=== Summary ==="
          if [ -f "resources/python/bin/python3" ] && [ -f "resources/ffmpeg/ffmpeg" ] && [ -f "resources/python/downloader.py" ]; then
            echo "✓ All dependencies ready for bundling!"
          else
            echo "✗ Some dependencies are missing"
            exit 1
          fi
      
      - name: Build app
        run: |
          pnpm vite build
          ARCH_FLAG=""
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            ARCH_FLAG="--arm64"
          else
            ARCH_FLAG="--x64"
          fi
          pnpm electron-builder --linux $ARCH_FLAG
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.arch }}
          path: dist-electron/*.{AppImage,deb,rpm}
          retention-days: 30
