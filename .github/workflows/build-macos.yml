name: Build macOS

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Install Homebrew dependencies
        run: |
          # Install FFmpeg via Homebrew (available on GitHub Actions runners)
          brew install ffmpeg
      
      - name: Bundle Python and FFmpeg
        run: |
          # Use the bundling script approach (same as local builds)
          # This ensures consistency and proper venv setup
          
          # Create resources directory structure
          mkdir -p resources/python
          mkdir -p resources/ffmpeg
          
          echo ""
          echo "=== Step 1: Python ==="
          echo "Setting up Python environment..."
          
          # Check if Python 3 is available
          if command -v python3 &> /dev/null; then
            PYTHON_VERSION=$(python3 --version | cut -d' ' -f2)
            echo "Found Python: $PYTHON_VERSION"
            
            # Create a virtual environment
            # Use --copies to avoid symlinks (better for app bundles)
            python3 -m venv --copies resources/python
            
            # Install yt-dlp in the venv
            echo "Installing yt-dlp..."
            resources/python/bin/pip install --upgrade pip
            resources/python/bin/pip install yt-dlp
            
            # CRITICAL: Fix pyvenv.cfg to use relative paths instead of hardcoded build machine paths
            # This makes the venv portable across different machines
            echo "Making venv portable..."
            PYTHON_VERSION_SHORT=$(resources/python/bin/python3 --version 2>&1 | awk '{print $2}' | cut -d. -f1,2)
            
            # Update pyvenv.cfg to use relative paths
            cat > resources/python/pyvenv.cfg <<EOF
home = bin
include-system-site-packages = false
version = $PYTHON_VERSION_SHORT
executable = bin/python3
EOF
            
            # Fix all shebang lines in Python scripts to use relative paths
            find resources/python/bin -type f -name "*.py" -exec sed -i '' "1s|^#!.*python.*|#!/usr/bin/env python3|" {} \;
            find resources/python/bin -type f ! -name "*.py" -exec grep -l "^#!.*python" {} \; | while read script; do
                sed -i '' "1s|^#!.*|#!/usr/bin/env python3|" "$script"
            done
            
            # Ensure Python executable has correct permissions
            chmod +x resources/python/bin/python3
            
            # Make sure all scripts are executable
            find resources/python/bin -type f -exec chmod +x {} \;
            
            echo "✓ Python environment created and made portable"
          else
            echo "✗ Python 3 not found"
            exit 1
          fi
          
          # Copy downloader.py
          if [ -f "python/downloader.py" ]; then
            cp python/downloader.py resources/python/downloader.py
            echo "✓ Copied downloader.py"
          else
            echo "✗ downloader.py not found"
            exit 1
          fi
          
          echo ""
          echo "=== Step 2: FFmpeg ==="
          echo "Setting up FFmpeg..."
          
          # Check if FFmpeg is available (should be from Homebrew step)
          if command -v ffmpeg &> /dev/null; then
            FFMPEG_VERSION=$(ffmpeg -version | head -n1)
            echo "Found FFmpeg: $FFMPEG_VERSION"
            
            # Copy system FFmpeg
            cp $(which ffmpeg) resources/ffmpeg/ffmpeg
            chmod +x resources/ffmpeg/ffmpeg
            echo "✓ FFmpeg copied"
          else
            echo "✗ FFmpeg not found"
            exit 1
          fi
          
          echo ""
          echo "=== Summary ==="
          if [ -f "resources/python/bin/python3" ] && [ -f "resources/ffmpeg/ffmpeg" ] && [ -f "resources/python/downloader.py" ]; then
            echo "✓ All dependencies ready for bundling!"
          else
            echo "✗ Some dependencies are missing"
            exit 1
          fi
      
      - name: Build app
        run: |
          pnpm vite build
          ARCH_FLAG=""
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            ARCH_FLAG="--arm64"
          else
            ARCH_FLAG="--x64"
          fi
          pnpm electron-builder --mac $ARCH_FLAG
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: dist-electron/*.dmg
          retention-days: 30
