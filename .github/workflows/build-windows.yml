name: Build Windows

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86, arm64]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Bundle Python and FFmpeg
        shell: pwsh
        run: |
          # Create resources directories
          New-Item -ItemType Directory -Force -Path resources/python | Out-Null
          New-Item -ItemType Directory -Force -Path resources/ffmpeg | Out-Null
          
          # Download Python embeddable (adjust version/arch as needed)
          $pythonArch = if ("${{ matrix.arch }}" -eq "x86") { "win32" } elseif ("${{ matrix.arch }}" -eq "arm64") { "arm64" } else { "amd64" }
          $pythonVersion = "3.12.0"
          $pythonUrl = "https://www.python.org/ftp/python/$pythonVersion/python-$pythonVersion-embed-$pythonArch.zip"
          
          Write-Host "Downloading Python embeddable..."
          Invoke-WebRequest -Uri $pythonUrl -OutFile python-embed.zip
          Expand-Archive -Path python-embed.zip -DestinationPath resources/python -Force
          Remove-Item python-embed.zip
          
          # Install pip
          Write-Host "Installing pip..."
          Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile get-pip.py
          & "resources/python/python.exe" get-pip.py
          Remove-Item get-pip.py
          
          # Install yt-dlp
          Write-Host "Installing yt-dlp..."
          & "resources/python/python.exe" -m pip install yt-dlp
          
          # Copy downloader.py
          Copy-Item python/downloader.py resources/python/downloader.py
          
          # Download FFmpeg
          Write-Host "Downloading FFmpeg..."
          $ffmpegUrl = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"
          Invoke-WebRequest -Uri $ffmpegUrl -OutFile ffmpeg.zip
          Expand-Archive -Path ffmpeg.zip -DestinationPath ffmpeg-temp -Force
          Copy-Item ffmpeg-temp/ffmpeg-*/bin/ffmpeg.exe resources/ffmpeg/ffmpeg.exe
          Remove-Item -Recurse -Force ffmpeg-temp
          Remove-Item ffmpeg.zip
      
      - name: Build app
        shell: pwsh
        run: |
          pnpm vite build
          $arch = if ("${{ matrix.arch }}" -eq "x86") { "ia32" } else { "${{ matrix.arch }}" }
          pnpm electron-builder --win --$arch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.arch }}
          path: dist-electron/*.exe
          retention-days: 30

